# GitHub Actions - Scheduled Integration Tests
# Runs 4 times per week to verify TikTok downloads still work

name: ğŸ” Scheduled TikTok Integration Tests

# Run 4 times per week: Monday, Wednesday, Friday, Sunday at 9:00 UTC
on:
  schedule:
    - cron: '0 9 * * 1,3,5,0'  # Mon, Wed, Fri, Sun at 9:00 UTC
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
  
  # Also run on push to main (optional - remove if you don't want)
  push:
    branches: [ main, master ]
    paths:
      - 'tests/test_integration.py'
      - '.github/workflows/scheduled-tests.yml'

# Limit permissions for security
permissions:
  contents: read
  issues: write  # Needed to create issues on failure

jobs:
  integration-test:
    name: Test TikTok Downloads
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Kill job if it takes too long
    
    steps:
    # Step 1: Checkout code
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    # Step 2: Setup Python (only latest version to save time)
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # Cache dependencies

    # Step 3: Install dependencies with caching
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest  # If you want to use pytest instead of unittest

    # Step 4: Run integration tests
    - name: ğŸ§ª Run TikTok integration tests
      id: integration_tests
      run: |
        echo "Running integration tests..."
        python tests/test_integration.py
      continue-on-error: true  # Don't fail immediately, handle below

    # Step 5: Create issue if tests fail
    - name: ğŸš¨ Create issue on failure
      if: steps.integration_tests.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'âš ï¸ TikTok Integration Tests Failed';
          const body = `## ğŸ”´ Integration Tests Failed
          
          **Date:** ${new Date().toLocaleString()}
          **Workflow:** ${context.workflow}
          **Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          ### Possible Causes:
          - ğŸ”§ TikTok API has changed
          - ğŸ“¦ yt-dlp needs updating
          - ğŸŒ Network/geo-blocking issues
          - ğŸš« Test video was removed or made private
          
          ### Next Steps:
          1. Check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
          2. Try updating yt-dlp: \`pip install --upgrade yt-dlp\`
          3. Verify the test video URL is still accessible
          4. Check if TikTok introduced breaking changes
          
          ### Quick Fix Commands:
          \`\`\`bash
          # Update yt-dlp
          pip install --upgrade yt-dlp
          
          # Test manually
          python tests/test_integration.py
          \`\`\`
          
          ---
          *This issue was automatically created by GitHub Actions.*
          `;
          
          // Check if an issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['automated-test-failure']
          });
          
          if (issues.data.length === 0) {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated-test-failure', 'bug', 'needs-investigation']
            });
            console.log('Created new issue for test failure');
          } else {
            // Add comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: `### Another failure detected\n\n**Date:** ${new Date().toLocaleString()}\n**Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });
            console.log('Added comment to existing issue');
          }

    # Step 6: Fail the workflow if tests failed
    - name: âŒ Fail workflow if tests failed
      if: steps.integration_tests.outcome == 'failure'
      run: exit 1

  # Optional: Close auto-generated issues when tests pass again
  close-resolved-issues:
    name: Close Resolved Issues
    runs-on: ubuntu-latest
    needs: integration-test
    if: success()
    
    steps:
    - name: ğŸ” Check for open automated issues
      uses: actions/github-script@v7
      with:
        script: |
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['automated-test-failure']
          });
          
          for (const issue of issues.data) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `### âœ… Tests are now passing!\n\n**Date:** ${new Date().toLocaleString()}\n**Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\nThe integration tests are now passing. This issue is being automatically closed.`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
            
            console.log(`Closed issue #${issue.number}`);
          }
